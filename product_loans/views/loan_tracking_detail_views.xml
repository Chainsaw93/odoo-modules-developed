<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista lista de seguimiento detallado -->
    <record id="view_loan_tracking_detail_tree" model="ir.ui.view">
        <field name="name">loan.tracking.detail.tree</field>
        <field name="model">loan.tracking.detail</field>
        <field name="arch" type="xml">
            <list string="Seguimiento de Préstamos" create="false">
                <field name="loan_date"/>
                <field name="picking_id"/>
                <field name="partner_id"/>
                <field name="product_id"/>
                <field name="lot_id" optional="show"/>
                <field name="quantity"/>
                <field name="status" 
                       decoration-success="status == 'sold'"
                       decoration-info="status == 'active'"
                       decoration-warning="status == 'pending_resolution'"
                       decoration-danger="is_overdue"/>
                <field name="days_in_loan"/>
                <field name="expected_return_date" optional="show"/>
                <field name="is_overdue" column_invisible="1"/>
                <field name="resolution_date" optional="hide"/>
                <field name="original_cost" optional="hide" groups="base.group_user"/>
                <field name="sale_price" optional="hide" groups="base.group_user"/>
            </list>
        </field>
    </record>

    <!-- Vista formulario de seguimiento detallado -->
    <record id="view_loan_tracking_detail_form" model="ir.ui.view">
        <field name="name">loan.tracking.detail.form</field>
        <field name="model">loan.tracking.detail</field>
        <field name="arch" type="xml">
            <form string="Detalle de Préstamo" create="false">
                <header>
                    <field name="status" widget="statusbar" 
                           statusbar_visible="active,sold,returned_good,returned_damaged"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_related_documents" 
                                type="object"
                                class="oe_stat_button" 
                                icon="fa-file-text-o"
                                string="Ver Documento"/>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="display_name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group string="Información del Préstamo">
                            <field name="picking_id"/>
                            <field name="product_id"/>
                            <field name="lot_id"/>
                            <field name="quantity"/>
                            <field name="loan_date"/>
                        </group>
                        <group string="Cliente y Estado">
                            <field name="partner_id"/>
                            <field name="expected_return_date"/>
                            <field name="days_in_loan"/>
                            <field name="is_overdue"/>
                            <field name="resolution_date"/>
                        </group>
                    </group>

                    <group string="Información Financiera" groups="base.group_user">
                        <group>
                            <field name="original_cost"/>
                            <field name="sale_price" invisible="status != 'sold'"/>
                        </group>
                        <group>
                            <!-- Espacio para más campos financieros -->
                        </group>
                    </group>

                    <group string="Referencias" invisible="status == 'active'">
                        <field name="sale_order_line_id" invisible="status != 'sold'"/>
                        <field name="return_picking_id" invisible="status not in ('returned_good', 'returned_damaged', 'returned_defective')"/>
                    </group>

                    <notebook>
                        <page string="Observaciones" name="notes">
                            <group>
                                <field name="notes" nolabel="1" placeholder="Observaciones generales..."/>
                                <field name="return_condition_notes" nolabel="1" 
                                       placeholder="Notas sobre condición de devolución..."
                                       invisible="status not in ('returned_good', 'returned_damaged', 'returned_defective')"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Vista búsqueda de seguimiento detallado -->
    <record id="view_loan_tracking_detail_search" model="ir.ui.view">
        <field name="name">loan.tracking.detail.search</field>
        <field name="model">loan.tracking.detail</field>
        <field name="arch" type="xml">
            <search string="Buscar Seguimiento">
                <field name="picking_id"/>
                <field name="partner_id"/>
                <field name="product_id"/>
                <field name="lot_id"/>
                <field name="status"/>
                
                <!-- Filtros predefinidos -->
                <filter name="active" string="Activos" domain="[('status', '=', 'active')]"/>
                <filter name="overdue" string="Vencidos" domain="[('is_overdue', '=', True)]"/>
                <filter name="sold" string="Vendidos" domain="[('status', '=', 'sold')]"/>
                <filter name="returned" string="Devueltos" domain="[('status', 'in', ('returned_good', 'returned_damaged', 'returned_defective'))]"/>
                
                <separator/>
                
                <filter name="this_month" string="Este Mes" 
                        domain="[('loan_date', '>=', (context_today() - datetime.timedelta(days=30)).strftime('%Y-%m-%d'))]"/>
                <filter name="this_year" string="Este Año" 
                        domain="[('loan_date', '>=', (context_today().replace(month=1, day=1)).strftime('%Y-%m-%d'))]"/>

                <!-- Agrupaciones -->
                <group expand="0" string="Agrupar por">
                    <filter name="group_by_status" string="Estado" context="{'group_by': 'status'}"/>
                    <filter name="group_by_partner" string="Cliente" context="{'group_by': 'partner_id'}"/>
                    <filter name="group_by_product" string="Producto" context="{'group_by': 'product_id'}"/>
                    <filter name="group_by_picking" string="Préstamo" context="{'group_by': 'picking_id'}"/>
                    <filter name="group_by_loan_date" string="Fecha Préstamo" context="{'group_by': 'loan_date:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Acción principal para seguimiento -->
    <record id="action_loan_tracking_detail" model="ir.actions.act_window">
        <field name="name">Seguimiento de Préstamos</field>
        <field name="res_model">loan.tracking.detail</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_loan_tracking_detail_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No hay registros de seguimiento
            </p>
            <p>
                El seguimiento detallado se crea automáticamente cuando se validan préstamos.
                Aquí podrás ver el estado y progreso de cada producto prestado.
            </p>
        </field>
    </record>

    <!-- Vista kanban para dashboard de seguimiento -->
    <record id="view_loan_tracking_detail_kanban" model="ir.ui.view">
        <field name="name">loan.tracking.detail.kanban</field>
        <field name="model">loan.tracking.detail</field>
        <field name="arch" type="xml">
            <kanban default_group_by="status" class="o_kanban_small_column">
                <field name="picking_id"/>
                <field name="partner_id"/>
                <field name="product_id"/>
                <field name="lot_id"/>
                <field name="quantity"/>
                <field name="days_in_loan"/>
                <field name="is_overdue"/>
                <field name="status"/>
                <field name="expected_return_date"/>
                
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <div class="oe_kanban_content">
                                <div class="o_kanban_record_top">
                                    <div class="o_kanban_record_headings">
                                        <strong class="o_kanban_record_title">
                                            <field name="product_id"/>
                                        </strong>
                                        <div class="o_kanban_record_subtitle text-muted">
                                            <field name="partner_id"/> • <field name="picking_id"/>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_record_body">
                                    <div t-if="record.lot_id.value" class="text-muted">
                                        S/N: <field name="lot_id"/>
                                    </div>
                                    <div>
                                        Cantidad: <field name="quantity"/>
                                    </div>
                                    <div class="text-muted">
                                        <field name="days_in_loan"/> días en préstamo
                                    </div>
                                    <div t-if="record.expected_return_date.value" class="text-muted">
                                        Vence: <field name="expected_return_date"/>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_record_bottom">
                                    <div class="oe_kanban_bottom_left">
                                        <span t-if="record.is_overdue.raw_value" class="badge bg-danger">
                                            Vencido
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Dashboard de préstamos vencidos -->
    <record id="action_overdue_tracking_dashboard" model="ir.actions.act_window">
        <field name="name">Préstamos Vencidos</field>
        <field name="res_model">loan.tracking.detail</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="domain">[('is_overdue', '=', True), ('status', '=', 'active')]</field>
        <field name="context">{'search_default_overdue': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                ¡No hay préstamos vencidos!
            </p>
            <p>
                Todos los préstamos están al día o han sido resueltos.
            </p>
        </field>
    </record>
</odoo>