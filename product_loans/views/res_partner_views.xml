<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista formulario de cliente con información de préstamos -->
    <record id="view_partner_form_loan_info" model="ir.ui.view">
        <field name="name">res.partner.form.loan.info</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_form"/>
        <field name="arch" type="xml">
            <!-- Botones estadísticos de préstamos -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_loans" 
                        type="object"
                        class="oe_stat_button" 
                        icon="fa-exchange"
                        invisible="loan_count == 0">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="loan_count"/>
                        </span>
                        <span class="o_stat_text">Préstamos</span>
                    </div>
                </button>

                <button name="action_view_loans" 
                        type="object"
                        class="oe_stat_button" 
                        icon="fa-clock-o"
                        invisible="active_loans_count == 0"
                        context="{'default_domain': [('loaned_to_partner_id', '=', id), ('loan_state', 'in', ['active', 'in_trial', 'partially_resolved'])]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="active_loans_count"/>
                        </span>
                        <span class="o_stat_text">Activos</span>
                    </div>
                </button>

                <button name="action_view_loans" 
                        type="object"
                        class="oe_stat_button" 
                        icon="fa-exclamation-triangle"
                        invisible="overdue_loans_count == 0"
                        context="{'default_domain': [('loaned_to_partner_id', '=', id), ('is_overdue', '=', True)]}">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value text-danger">
                            <field name="overdue_loans_count"/>
                        </span>
                        <span class="o_stat_text">Vencidos</span>
                    </div>
                </button>
            </xpath>

            <!-- Página específica para configuración de préstamos -->
            <xpath expr="//notebook" position="inside">
                <page string="Préstamos" name="loans" 
                      invisible="loan_count == 0 and active_loans_count == 0">
                    <group>
                        <group string="Límites y Configuración">
                            <field name="max_loan_value" 
                                   widget="monetary" 
                                   options="{'currency_field': 'currency_id'}"/>
                            <field name="max_loan_items"/>
                            <field name="dedicated_loan_location_id" readonly="1"/>
                        </group>
                        <group string="Estado Actual">
                            <field name="loan_count" readonly="1"/>
                            <field name="active_loans_count" readonly="1"/>
                            <field name="overdue_loans_count" readonly="1"/>
                        </group>
                    </group>
                    
                    <!-- Alertas visuales -->
                    <div class="alert alert-danger" 
                         invisible="overdue_loans_count == 0" 
                         role="alert">
                        <strong>¡Atención!</strong> Este cliente tiene 
                        <field name="overdue_loans_count" readonly="1" nolabel="1"/>
                        préstamo(s) vencido(s). Se recomienda contactarlo inmediatamente.
                    </div>
                    
                    <div class="alert alert-warning" 
                         invisible="not max_loan_value or active_loans_count == 0" 
                         role="alert">
                        <strong>Límite de Valor:</strong> Verificar que los préstamos activos 
                        no excedan el límite configurado de 
                        <field name="max_loan_value" widget="monetary" readonly="1" nolabel="1"/>.
                    </div>
                </page>
            </xpath>

            <!-- Campo moneda oculto para widget monetario -->
            <xpath expr="//field[@name='category_id']" position="after">
                <field name="currency_id" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Vista lista de clientes con información de préstamos -->
    <record id="view_partner_tree_loan_info" model="ir.ui.view">
        <field name="name">res.partner.tree.loan.info</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_partner_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='phone']" position="after">
                <field name="active_loans_count" string="Préstamos Activos" optional="show"/>
                <field name="overdue_loans_count" string="Vencidos" optional="show" 
                       decoration-danger="overdue_loans_count > 0"/>
                <field name="max_loan_value" string="Límite Préstamo" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Vista búsqueda de clientes con filtros de préstamos -->
    <record id="view_partner_search_loan_filters" model="ir.ui.view">
        <field name="name">res.partner.search.loan.filters</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.view_res_partner_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <!-- Filtros específicos de préstamos -->
                <separator/>
                <filter name="has_active_loans" string="Con Préstamos Activos" 
                        domain="[('active_loans_count', '>', 0)]"/>
                <filter name="has_overdue_loans" string="Con Préstamos Vencidos" 
                        domain="[('overdue_loans_count', '>', 0)]"/>
                <filter name="has_loan_limits" string="Con Límites Configurados" 
                        domain="['|', ('max_loan_value', '>', 0), ('max_loan_items', '>', 0)]"/>
                <filter name="has_dedicated_location" string="Con Ubicación Dedicada" 
                        domain="[('dedicated_loan_location_id', '!=', False)]"/>
                
                <!-- Agrupaciones adicionales -->
                <group expand="0" string="Agrupar por">
                    <filter name="group_by_loan_status" string="Estado de Préstamos" 
                            context="{'group_by': 'has_active_loans'}"/>
                    <filter name="group_by_is_company" string="Es Compañía" 
                            context="{'group_by': 'is_company'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Vista kanban de clientes con información de préstamos -->
    <record id="view_partner_kanban_loan_info" model="ir.ui.view">
        <field name="name">res.partner.kanban.loan.info</field>
        <field name="model">res.partner</field>
        <field name="inherit_id" ref="base.res_partner_kanban_view"/>
        <field name="arch" type="xml">
            <!-- Agregar campos necesarios -->
            <xpath expr="//field[@name='is_company']" position="after">
                <field name="active_loans_count"/>
                <field name="overdue_loans_count"/>
                <field name="loan_count"/>
            </xpath>
            
            <!-- Mostrar información de préstamos en la tarjeta -->
            <xpath expr="//footer/div" position="inside">
                <div t-if="record.active_loans_count.raw_value > 0" class="mt-2">
                    <span class="badge bg-info me-1">
                        <i class="fa fa-exchange"/> <t t-esc="record.active_loans_count.value"/> activos
                    </span>
                    <span t-if="record.overdue_loans_count.raw_value > 0" class="badge bg-danger">
                        <i class="fa fa-exclamation-triangle"/> <t t-esc="record.overdue_loans_count.value"/> vencidos
                    </span>
                </div>
            </xpath>
        </field>
    </record>

    <!-- Acción específica para ver préstamos de un cliente -->
    <record id="action_partner_loans_detailed" model="ir.actions.act_window">
        <field name="name">Préstamos del Cliente</field>
        <field name="res_model">stock.picking</field>
        <field name="view_mode">list,form</field>
        <field name="domain">[('loaned_to_partner_id', '=', active_id), ('is_loan', '=', True)]</field>  <!-- CAMBIO AQUÍ -->
        <field name="context">{
            'default_loaned_to_partner_id': active_id,  <!-- CAMBIO AQUÍ -->
            'search_default_group_by_state': 1
        }</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Este cliente no tiene préstamos registrados
            </p>
            <p>
                Desde aquí puedes ver todos los préstamos asociados a este cliente,
                tanto activos como históricos.
            </p>
        </field>
    </record>
</odoo>