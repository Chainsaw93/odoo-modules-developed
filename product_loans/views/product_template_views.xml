<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Vista formulario de producto con información de préstamos -->
    <record id="view_product_template_form_loan_info" model="ir.ui.view">
        <field name="name">product.template.form.loan.info</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            <!-- Botones estadísticos de préstamos -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button name="action_view_current_loans" 
                        type="object"
                        class="oe_stat_button" 
                        icon="fa-exchange"
                        invisible="loan_history_count == 0">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="qty_in_loans"/>
                        </span>
                        <span class="o_stat_text">En Préstamo</span>
                    </div>
                </button>

                <button name="action_view_loan_history" 
                        type="object"
                        class="oe_stat_button" 
                        icon="fa-history"
                        invisible="loan_history_count == 0">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="loan_history_count"/>
                        </span>
                        <span class="o_stat_text">Historial</span>
                    </div>
                </button>
            </xpath>

            <!-- Página específica para configuración de préstamos -->
            <xpath expr="//notebook" position="inside">
                <page string="Préstamos" name="loans">
                    <group>
                        <group string="Configuración de Préstamos">
                            <field name="allow_loans"/>
                            <field name="min_loan_qty" invisible="not allow_loans"/>
                            <field name="loan_warning" invisible="not allow_loans"/>
                        </group>
                        <group string="Estado Actual" invisible="not allow_loans">
                            <field name="qty_available_real" readonly="1"/>
                            <field name="qty_in_loans" readonly="1"/>
                            <field name="qty_reserved_for_loans" readonly="1"/>
                            <field name="serial_numbers_in_loans" readonly="1" 
                                   invisible="tracking != 'serial'"/>
                        </group>
                    </group>
                    
                    <div class="alert alert-warning" 
                         invisible="not allow_loans or not loan_warning" 
                         role="alert">
                        <strong>Advertencia de Préstamo:</strong>
                        <field name="loan_warning" readonly="1" nolabel="1"/>
                    </div>
                </page>
            </xpath>

            <!-- Campos invisibles para computaciones -->
            <xpath expr="//sheet" position="inside">
                <field name="qty_available_real" invisible="1"/>
                <field name="qty_in_loans" invisible="1"/>
                <field name="qty_reserved_for_loans" invisible="1"/>
                <field name="serial_numbers_in_loans" invisible="1"/>
                <field name="loan_history_count" invisible="1"/>
            </xpath>
        </field>
    </record>

    <!-- Vista lista de productos con columnas de préstamos -->
    <record id="view_product_template_tree_loan_info" model="ir.ui.view">
        <field name="name">product.template.tree.loan.info</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_tree_view"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='qty_available']" position="after">
                <field name="qty_available_real" string="Disponible Real" optional="hide"/>
                <field name="qty_in_loans" string="En Préstamo" optional="show"/>
                <field name="allow_loans" string="Permite Préstamos" optional="hide"/>
            </xpath>
        </field>
    </record>

    <!-- Vista búsqueda de productos con filtros de préstamos -->
    <record id="view_product_template_search_loan_filters" model="ir.ui.view">
        <field name="name">product.template.search.loan.filters</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_search_view"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <!-- Filtros de préstamos -->
                <separator/>
                <filter name="allow_loans" string="Permite Préstamos" 
                        domain="[('allow_loans', '=', True)]"/>
                <filter name="currently_loaned" string="Actualmente Prestados" 
                        domain="[('qty_in_loans', '>', 0)]"/>
                <filter name="low_real_stock" string="Stock Real Bajo" 
                        domain="[('qty_available_real', '&lt;=', 5)]"/>
                <filter name="has_loan_history" string="Con Historial de Préstamos" 
                        domain="[('loan_history_count', '>', 0)]"/>
                        
                <separator/>
                <filter name="with_loan_warning" string="Con Advertencias de Préstamo" 
                        domain="[('loan_warning', '!=', False)]"/>
                
                <!-- Agrupaciones adicionales -->
                <group expand="0" string="Agrupar por">
                    <filter name="group_by_allow_loans" string="Permite Préstamos" 
                            context="{'group_by': 'allow_loans'}"/>
                </group>
            </xpath>
        </field>
    </record>

    <!-- Vista kanban de productos con información de préstamos - CORREGIDA -->
    <record id="view_product_template_kanban_loan_info" model="ir.ui.view">
        <field name="name">product.template.kanban.loan.info</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_kanban_view"/>
        <field name="arch" type="xml">
            <!-- Agregar campos necesarios -->
            <xpath expr="//field[@name='currency_id']" position="after">
                <field name="qty_in_loans"/>
                <field name="qty_available_real"/>
                <field name="allow_loans"/>
            </xpath>
            
            <!-- Agregar información de préstamos después del precio -->
            <xpath expr="//span[field[@name='list_price']]" position="after">
                <div t-if="record.qty_in_loans.raw_value > 0" class="text-warning mt-1">
                    <i class="fa fa-exchange"/> En préstamo: <t t-esc="record.qty_in_loans.value"/>
                </div>
                <div t-if="record.allow_loans.raw_value and record.qty_available_real.raw_value &lt;= 0" 
                     class="text-danger mt-1">
                    <i class="fa fa-warning"/> Sin stock real disponible
                </div>
            </xpath>
        </field>
    </record>
</odoo>